<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Laxoria Social</title>
<style>
  body { margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:white; color:#333;}
  header { background:white; padding:20px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  header h1 {
    font-family: 'Brush Script MT', cursive;
    font-size:48px;
    background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin:0;
  }
  section { padding:20px; margin-bottom:10px; display:none;}
  .active { display:block;}
  .nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:10px 0; box-shadow:0 -2px 5px rgba(0,0,0,0.1);}
  .nav button { background:none; border:none; font-size:26px; cursor:pointer; background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
  .stories, .feed { display:flex; overflow-x:auto; gap:10px; }
  .story, .post { background:white; padding:10px; border-radius:10px; min-width:100px; flex-shrink:0; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  .story img, .post img { border-radius:50%; width:50px; height:50px; }
  .post img, .post video { border-radius:10px; width:100%; margin-top:5px; }
  .profile { background:white; padding:10px; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
  .btn { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; margin-right:5px; font-weight:bold; background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); color:white;}
  input[type="text"], input[type="email"], input[type="password"] { width:100%; padding:8px; border-radius:5px; border:1px solid #ccc; margin-bottom:10px;}
</style>
</head>
<body>
<header>
  <h1>Laxoria</h1>
</header>

<!-- Authentication Page -->
<section id="auth" class="active">
  <h2 style="background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Login / Register</h2>
  <input type="email" id="authEmail" placeholder="Email" />
  <input type="password" id="authPassword" placeholder="Password" />
  <button class="btn" onclick="login()">Login</button>
  <button class="btn" onclick="register()">Register</button>
  <p id="authStatus"></p>
</section>

<!-- Home Page -->
<section id="home">
  <h2 style="background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Home</h2>
  <div class="stories" id="stories"></div>
  <div class="feed" id="feed"></div>
</section>

<!-- Messages Page -->
<section id="messages">
  <h2 style="background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Messages</h2>
  <div id="messagesList"></div>
</section>

<!-- Profile Page -->
<section id="profile">
  <h2 style="background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Profile</h2>
  <div class="profile" id="profileInfo"></div>

  <h3>Upload Image / Video</h3>
  <input type="file" id="fileInput" />
  <button class="btn" onclick="uploadFile()">Upload</button>
  <p id="uploadStatus"></p>

  <h3>Account Type</h3>
  <select id="accountType">
    <option value="personal">Personal</option>
    <option value="business">Business</option>
  </select>

  <h3>Privacy</h3>
  <select id="privacy">
    <option value="public">Public</option>
    <option value="private">Private</option>
  </select>

  <button class="btn" onclick="logout()">Logout</button>
</section>

<!-- Search Page -->
<section id="search">
  <h2 style="background: linear-gradient(to right, #A8E6CF, #C39BD3, #FF6F91); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Search</h2>
  <input type="text" id="searchInput" placeholder="ابحث عن فيديوهات أو أشخاص..." />
</section>

<!-- Navigation Bar -->
<div class="nav">
  <button onclick="showPage('home')">🏠</button>
  <button onclick="showPage('messages')">💬</button>
  <button onclick="showPage('search')">🔍</button>
  <button onclick="showPage('profile')">👤</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ====== Supabase Client (إصلاح التعارض) ====== */
const SUPABASE_URL = 'https://haeptsutgwyplaaozuev.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhZXB0c3V0Z3d5cGxhYW96dWV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNzAyNTIsImV4cCI6MjA3MDY0NjI1Mn0.7rEfjIGrTqlVhjCByWF4wirCe3X7JEMo6yGCZob7wOU';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;

/* ====== Navigation ====== */
function showPage(pageId){
  const pages = ['auth','home','messages','profile','search'];
  pages.forEach(id => document.getElementById(id).classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

/* ====== Auth (Register / Login / Logout) ====== */
async function register() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const { data, error } = await sb.auth.signUp({ email, password });
  const authStatus = document.getElementById('authStatus');
  if(error){ authStatus.textContent = error.message; return; }
  authStatus.textContent = 'Registered! Please check your email (if confirmation enabled) then login.';
}

async function login() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  const authStatus = document.getElementById('authStatus');
  if(error){ authStatus.textContent = error.message; return; }
  currentUser = data?.user || null;
  authStatus.textContent = 'Logged in!';
  showPage('home');
  loadPosts();
  loadProfile();
}

async function logout() {
  await sb.auth.signOut();
  currentUser = null;
  showPage('auth');
}

/* حافظ على الجلسة عند التحديث */
sb.auth.onAuthStateChange((event, session) => {
  currentUser = session?.user || null;
  if(currentUser){
    showPage('home');
    loadPosts();
    loadProfile();
  } else {
    showPage('auth');
  }
});

/* ====== Feed / Posts ====== */
async function loadPosts(){
  if(!currentUser) return;
  const { data, error } = await sb
    .from('Posts')
    .select('*')
    .order('created_at', { ascending:false });

  if(error){ console.error(error); return; }

  const feed = document.getElementById('feed');
  feed.innerHTML = '';
  data.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML =
      `<div><strong>User ${post.user_id}</strong></div>
       <p>${post.content ?? ''}</p>` +
      (post.image_url ? `<img src="${post.image_url}" />` : '') +
      (post.video_url ? `<video src="${post.video_url}" controls></video>` : '');
    feed.appendChild(div);
  });
}

/* ====== Profile ====== */
async function loadProfile(){
  if(!currentUser) return;

  // لو جدول Users ما موجود، هذا النداء راح يفشل بهدوء
  const { data, error } = await sb
    .from('Users')
    .select('*')
    .eq('id', currentUser.id)
    .single();

  const profileDiv = document.getElementById('profileInfo');
  if(error){
    // عرض معلومات أساسية حتى بدون جدول Users
    profileDiv.innerHTML = `<p>Email: ${currentUser.email}</p>
                            <p>Account Type: -</p>
                            <p>Privacy: -</p>`;
    return;
  }

  profileDiv.innerHTML = `<p>Email: ${currentUser.email}</p>
                          <p>Account Type: ${data?.account_type || 'Personal'}</p>
                          <p>Privacy: ${data?.privacy || 'Public'}</p>`;
}

/* ====== Upload (Storage + Post) ====== */
async function uploadFile() {
  if(!currentUser){ alert('Please login first'); return; }

  const file = document.getElementById('fileInput').files[0];
  const uploadStatus = document.getElementById('uploadStatus');
  if(!file){ uploadStatus.textContent = 'Please select a file first.'; return; }

  // اسم فريد للملف
  const fileName = `${currentUser.id}_${Date.now()}_${file.name}`;

  // رفع الملف
  const { data: upData, error: upErr } = await sb.storage.from('media').upload(fileName, file);
  if(upErr){ uploadStatus.textContent = 'Upload failed: ' + upErr.message; return; }

  // الحصول على الرابط العام (إصلاح الـ getPublicUrl)
  const { data: urlData } = sb.storage.from('media').getPublicUrl(fileName);
  const publicUrl = urlData?.publicUrl;
  if(!publicUrl){ uploadStatus.textContent = 'Could not get public URL.'; return; }

  // حفظ إعدادات الحساب بالبروفايل (اختياري إذا عندك جدول Users بنوع UUID)
  const accountType = document.getElementById('accountType').value;
  const privacy = document.getElementById('privacy').value;
  await sb.from('Users').upsert({
    id: currentUser.id,          // لازم الحقل id في Users يكون UUID
    account_type: accountType,
    privacy: privacy
  });

  // إضافة منشور
  const { error: postErr } = await sb.from('Posts').insert([{
    user_id: currentUser.id,     // لازم user_id في Posts يكون UUID
    content: 'Uploaded via profile',
    image_url: file.type.startsWith('image/') ? publicUrl : null,
    video_url: file.type.startsWith('video/') ? publicUrl : null,
    created_at: new Date()
  }]);

  if(postErr){ uploadStatus.textContent = 'DB insert error: ' + postErr.message; return; }

  uploadStatus.textContent = 'File uploaded successfully!';
  loadPosts();
}
</script>
</body>
</html>
